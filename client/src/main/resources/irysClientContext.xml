<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd">
   
    <!--    CLIENT   -->
    <bean id="messageFactory" class="org.springframework.ws.soap.saaj.SaajSoapMessageFactory"/>
    
    <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="systemPropertiesModeName" value="SYSTEM_PROPERTIES_MODE_OVERRIDE" />
        <property name="ignoreResourceNotFound" value="false" />
        <property name="locations" value="classpath:irys-client.properties" />           
    </bean>
    
    <bean name="FileMessageTrace" class="net.dryade.siri.client.message.BasicMessageTrace" lazy-init="true" init-method="init" destroy-method="close">
        <property name="baseFileName">
            <value>${siri.trace.fileName}</value>
        </property>
        <property name="directoryName">
            <value>${siri.trace.directory}</value>
        </property>
        <property name="flushPeriod">
            <value>${siri.trace.flushPeriod}</value>
        </property>
        <property name="maxFile">
            <value>${siri.trace.maximumFileCount}</value>
        </property>
        <property name="maxFileLength">
            <value>${siri.trace.maximumFileSize}</value>
        </property>
        <property name="dateFormat">
            <value>${siri.trace.dateFormat}</value>
        </property>
        <property name="separator">
            <value>${siri.trace.separator}</value>
        </property>
    </bean>
    
    <bean name="NoMessageTrace" class="net.dryade.siri.client.message.DummyMessageTrace" lazy-init="true" />
    
    <bean id="abstractClient" class="net.dryade.siri.client.ws.AbstractClient" abstract="true">
        <constructor-arg ref="messageFactory"/>
        <property name="defaultUri">
            <value>${siri.server}</value>
        </property>
        <property name="marshaller" ref="marshaller"/>
        <property name="unmarshaller" ref="marshaller"/>
        <property name="trace">
	    <ref bean="${siri.trace}"/>
        </property>
        <property name="requestorRefValue">
            <value>${siri.requestorRef}</value>
        </property>
        <property name="version">
            <value>${siri.version}</value>
        </property>
        <!-- required if a proxy is present -->
        <property name="proxyName">
            <value>${proxy.name}</value>
        </property>
        <property name="proxyPort">
            <value>${proxy.port}</value>
        </property>
        <property name="proxyDomain">
            <value>${proxy.domain}</value>
        </property> 
        <property name="proxyUser">
            <value>${proxy.user}</value>
        </property> 
        <property name="proxyPassword">
            <value>${proxy.password}</value>
        </property> 
        <property name="authUser">
            <value>${siri.authUser}</value>
        </property>
        <property name="authPassword">
            <value>${siri.authPass}</value>
        </property>
        <property name="requestCompressionRequired">
            <value>${siri.requestCompression}</value>
        </property>
        <property name="responseCompressionAllowed">
            <value>${siri.responseCompression}</value>
        </property>                 
        <property name="timeProvider" ref="timeProvider"/>
    </bean>

    <bean id="checkStatusClient" parent="abstractClient" class="net.dryade.siri.client.ws.CheckStatusClient">
        <property name="requestIdentifierPrefix">
            <value>${siri.checkStatus.requestIdentifierPrefix}</value>
        </property>
    </bean>  
        
    <bean id="generalMessageClient" parent="abstractClient" class="net.dryade.siri.client.ws.GeneralMessageClient">
        <property name="requestIdentifierPrefix">
            <value>${siri.generalMessage.requestIdentifierPrefix}</value>
        </property>
        <property name="infoChannelEncoded">
            <value>${siri.isInfoChannelEncoded}</value>
        </property>
    </bean>
    
    <bean id="stopMonitoringClient" parent="abstractClient" class="net.dryade.siri.client.ws.StopMonitoringClient">
        <property name="requestIdentifierPrefix">
            <value>${siri.stopMonitoring.requestIdentifierPrefix}</value>
        </property>
        <property name="multipleStopMonitoredSupported">
            <value>${siri.isMultipleStopMonitoredSupported}</value>
        </property>
    </bean>  
    
    <bean id="discoveryClient" parent="abstractClient" class="net.dryade.siri.client.ws.DiscoveryClient">
        <property name="requestIdentifierPrefix">
            <value>${siri.discovery.requestIdentifierPrefix}</value>
        </property>
    </bean>  
    
    <bean id="timeProvider" class="net.dryade.siri.client.common.TimeProvider" />
    <bean id="marshaller" class="org.springframework.oxm.xmlbeans.XmlBeansMarshaller"/>
    
    
    
    <!--    SEQUENCER   -->
    <bean name="RequestProcessManager" class="net.dryade.siri.sequencer.impl.RequestProcessManager"
		abstract="true">
		<!-- <property name="siriManager" ref="SiriServicesManagerBean" /> -->
        <property name="notifyManager" ref="SubscriptionManager" />
        <property name="period" value="60000" />
    </bean>
    
    <bean name="CheckStatusRequestProcessManager"
		class="net.dryade.siri.sequencer.impl.CheckStatusRequestProcessManager"
		scope="prototype" parent="RequestProcessManager">
        <property name="normalModePeriod"
			value="${siri.sequencer.CheckStatus.normalModePeriod}" />
        <property name="failureModePeriod"
			value="${siri.sequencer.CheckStatus.failureModePeriod}" />
        <property name="timeOffset" value="${siri.sequencer.CheckStatus.timeOffset}" />
        <property name="period"
			value="${siri.sequencer.CheckStatus.failureModePeriod}" />
        <property name="packetCount" value="1" />
        <property name="optimalPacketSize" value="10" />
    </bean>
    
    <bean name="GeneralMessageRequestProcessManager"
		class="net.dryade.siri.sequencer.impl.GeneralMessageRequestProcessManager"
		scope="prototype" parent="RequestProcessManager">
        <property name="timeOffset" value="${siri.sequencer.GeneralMessage.timeOffset}" />
        <property name="period"
			value="${siri.sequencer.GeneralMessage.period}" />
        <property name="packetCount" value="1" />
        <property name="optimalPacketSize" value="10" />
    </bean>

    <bean name="StopMonitoringRequestProcessManager"
		class="net.dryade.siri.sequencer.impl.StopMonitoringRequestProcessManager"
		scope="prototype" parent="RequestProcessManager">
        <property name="timeOffset" value="${siri.sequencer.StopMonitoring.timeOffset}" />
        <property name="period" value="${siri.sequencer.StopMonitoring.period}" />
        <property name="packetCount" value="${siri.sequencer.StopMonitoring.packetCount}" />
        <property name="optimalPacketSize"
			value="${siri.sequencer.StopMonitoring.optimalPacketSize}" />
    </bean>

    <bean name="Server1" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint1.key}" />
        <property name="requestorRef" value="${siri.endPoint1.requestorRef}" />
    </bean>
    <bean name="Server2" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint2.key}" />
        <property name="requestorRef" value="${siri.endPoint2.requestorRef}" />
    </bean>
    <bean name="Server3" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint3.key}" />
        <property name="requestorRef" value="${siri.endPoint3.requestorRef}" />
    </bean>
    <bean name="Server4" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint4.key}" />
        <property name="requestorRef" value="${siri.endPoint4.requestorRef}" />
    </bean>
    <bean name="Server5" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint5.key}" />
        <property name="requestorRef" value="${siri.endPoint5.requestorRef}" />
    </bean>
    <bean name="Server6" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint6.key}" />
        <property name="requestorRef" value="${siri.endPoint6.requestorRef}" />
    </bean>
    <bean name="Server7" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint7.key}" />
        <property name="requestorRef" value="${siri.endPoint7.requestorRef}" />
    </bean>
    <bean name="Server8" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint8.key}" />
        <property name="requestorRef" value="${siri.endPoint8.requestorRef}" />
    </bean>
    <bean name="Server9" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint9.key}" />
        <property name="requestorRef" value="${siri.endPoint9.requestorRef}" />
    </bean>
    <bean name="Server10" class="net.dryade.siri.sequencer.impl.SiriServer">
        <property name="id" value="${siri.endPoint10.key}" />
        <property name="requestorRef" value="${siri.endPoint10.requestorRef}" />
    </bean>

    <bean name="SubscriptionManager" class="net.dryade.siri.sequencer.impl.SubscriptionManager"
		lazy-init="true">
        <lookup-method name="getNewCSRequestProcessManager"
			bean="CheckStatusRequestProcessManager" />
        <lookup-method name="getNewGMRequestProcessManager"
			bean="GeneralMessageRequestProcessManager" />
        <lookup-method name="getNewSMRequestProcessManager"
			bean="StopMonitoringRequestProcessManager" />
        <property name="scanForNotificationPeriod" value="${siri.sequencer.notificationPeriod}" />
        <property name="managedServers">
            <map>
                <entry key="${siri.endPoint1.key}" value-ref="Server1" />
                <entry key="${siri.endPoint2.key}" value-ref="Server2" />
                <entry key="${siri.endPoint3.key}" value-ref="Server3" />
                <entry key="${siri.endPoint4.key}" value-ref="Server4" />
                <entry key="${siri.endPoint5.key}" value-ref="Server5" />
                <entry key="${siri.endPoint6.key}" value-ref="Server6" />
                <entry key="${siri.endPoint7.key}" value-ref="Server7" />
                <entry key="${siri.endPoint8.key}" value-ref="Server8" />
                <entry key="${siri.endPoint9.key}" value-ref="Server9" />
                <entry key="${siri.endPoint10.key}" value-ref="Server10" />
            </map>
        </property>
        <property name="managedServices">
            <list>
                <value>CheckStatusService</value>
                <value>StopMonitoringService</value>
                <value>GeneralMessageService</value>
            </list>
        </property>
    </bean>

</beans>
